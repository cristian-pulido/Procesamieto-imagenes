{% extends 'base/base.html' %}

{% block content %}

{% if object.user.groups.all.0.pk != user.groups.all.0.pk or not object.anonimo  %}
<script type="text/javascript">
        window.location="{% url 'login' %}";
</script>
{% endif %}

{% if not object.identificado  %}
    {% if object.user.pk == user.pk  %}
    <script type="text/javascript">
            window.location="{% url 'select' object.pk %}";
    </script>
    {% else %}
    <script type="text/javascript">
            window.location="{% url 'login' %}";
    </script>

    {% endif %}
{% endif %}



{% load scripts %}
{% load scripts_validacion %}
{% load scripts_procesamiento %}

<h3>Nombre del Estudio: {{object.get_name}}</h3>

<br>



<br><br>

<ul class="nav nav-tabs">
  <li class="nav-item">
    <a class="nav-link" data-toggle="tab" href="#series">Series</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" data-toggle="tab" href="#tags">Tags Dicom</a>
  </li>
  {% if object.parametrosmotioncorrect %}
  <li class="nav-item">
    <a class="nav-link active" data-toggle="tab" href="#mc">Movimiento de Cabeza</a>
  </li>
  {% endif %}
  <li class="nav-item">
    <a class="nav-link active" data-toggle="tab" href="#ejecucion">Procesamiento</a>
  </li>
</ul>
<div id="myTabContent" class="tab-content">
  <div class="tab-pane fade" id="series">
      <br>
      {% if object.user.pk == user.pk  %}
      <form>
      <button class="btn btn-default" formaction="{% url 'edit_select' object.pk %}" title="Editar"><i class="glyphicon glyphicon-pencil"></i> Editar Selección </button>

       </form> 
      {% endif %}
   
            
      {% mostrarimgdefecto as img_def %}
      
      <table class="table table-hover">
        <thead>
            <tr>
                <th> Nombre </th>
                <th> Tipo </th>
                {% if object.user.pk == user.pk %}
                <th> Eliminar </th>
                {% endif %}
            </tr>
        </thead>
        <tbody>

            {% for s in object.img_to_show_set.all %}
                <tr>
                    <td>{{ s }}</td>
                    <td>{% if s.img_defecto %}{{s.img_defecto}}{%endif%}</td>
                    {% if object.user.pk == user.pk %}
                    <td>
                    <form>
                  <button class="btn btn-danger" formaction="{% url 'img_eliminar' s.pk %}" title="Eliminar"><i class="glyphicon glyphicon-trash"></i></button>
                  
                   </form>
                    </td>
                    {% endif %}
                </tr>
            {% endfor%}
        </tbody>
    </table>
      
      
  </div>
    
  <div class="tab-pane fade" id="tags">
    <br>
    Series Encontradas en los archivos Dicom junto con sus parametros

    <br>  
    <br>


    {% get_name_images_by_file object.pk as images %}

    {% for img in images %}

    	{% get_tags_images img.nombre object.user.pk as tags_default %}

    	{% if tags_default %}

	    	<div class="container">
			  
			  <div class="panel-group">
			    <div class="panel panel-default">
			      <div class="panel-heading">
			        <h4 class="panel-title">
			          <a data-toggle="collapse" href="#collapse_{{img.pk}}">{{img.nombre}}</a>
			        </h4>
			      </div>
			      <div id="collapse_{{img.pk}}" class="panel-collapse collapse">
			        <div class="panel-body">
			        	<table class="table table-hover">
			        		<thead>
							    <tr>
							      <th scope="col">Ref. Dicom</th>
							      <th scope="col">Nombre</th>
							      <th scope="col"> Valor </th>
							      <th scope="col"> Valor Esperado</th>
							      <th scope="col"> Tolerancia</th>
							      <th scope="col"> Validación</th>

							    </tr>
							  </thead>
							  <tbody>
							  	{% for tag in tags_default %}
							  		{% get_camp_images_by_tag tag object as campo %}
							  		<tr>
                                      <td >{{campo.tag.num_tag}}</td>
                                      <td >{{campo.tag.name_tag}}</td>
                                      <td >{{campo.valor}} {{campo.medidas}}</td>
                                      <td >{{campo.v_esperado}}</td>
                                      <td >{{campo.precision}}</td>
                                      <td >
                                        {% if campo.cumple   %}   <span style="color:green" class="glyphicon glyphicon-check" ></span> 
                                        {% else  %}   <span style="color:red" class="glyphicon glyphicon-remove-circle"></span> {% endif %}

                                      </td>
							  		</tr>
							  	{% endfor %}

							  </tbody>

			        	</table>

			        	
			    	</div>
			      </div>
			    </div>
			  </div>
			</div>

		{% else %}

			<p>{{img.nombre}}

		{% endif %}

		<br>



    {% endfor %}


  </div>
  {% if object.parametrosmotioncorrect %}
  <div class="tab-pane fade  " id="mc">
    
  	<h3>Moviento de Cabeza</h3>

	<h4>Movimiento Medio</h4>
      <table class="table table-hover">
        <tbody>
        <tr>
          <th>Absoluto</th>
          <td>{{ object.parametrosmotioncorrect.absolute_func }} mm </td>
          <th>Relativo</th>
          <td>{{ object.parametrosmotioncorrect.relative_func }} mm</td>
        </tr>
        </tbody>
      </table>
      <center>
      <div id="div_func_desplazamiento"><!-- Plotly chart will be drawn inside this DIV --></div>
      <div id="div_func_rotaciones"><!-- Plotly chart will be drawn inside this DIV --></div>
      <div id="div_func_traslaciones"><!-- Plotly chart will be drawn inside this DIV --></div>
      </center>
    
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="{{object.parametrosmotioncorrect.graphic_desplazamiento_func}}"></script>
    <script src="{{object.parametrosmotioncorrect.graphic_rotacion_func}}"></script>
    <script src="{{object.parametrosmotioncorrect.graphic_traslacion_func}}"></script>


  </div>
    {% endif%}
    
  <div class="tab-pane fade  " id="ejecucion">
      
      {% get_img_def_set object as img_defect %}
      
      
    
  	<h3>Lista de Procesos Disponibles</h3>
        {% get_pipelines img_defect as pipe %}
      
      
      <div class="container">
      <ul class="nav nav-pills nav-stacked col-md-2">
         {% for p in pipe %} 
          <li ><a href="#pipe_{{p.pk}}" data-toggle="pill">{{p.nombre}}</a></li>
         {% endfor %}        
      </ul>
      <div class="tab-content col-md-10">
          
          {% for p in pipe %} 
          
          <div class="tab-pane" id="pipe_{{p.pk}}">
           
           <h3>{{p.nombre}}</h3>
           <ul>
               <li>Tipo Imagen: {{p.tipo_imagen}} </li>
               <li> 
                   <form>
                  <button class="btn btn-success" formaction="{% url 'config' object.pk p.pk p.tipo_imagen.pk %}" title="Añadir"><i class="glyphicon glyphicon-plus"> Añadir Configuración </i></button>
                  
                   </form>    
                   
               
               </li>
                   
           </ul>
           <h4>Configuraciones Disponibles</h4>      
              {% get_config object p as configs%}
              <table class="table table-hover">
              <thead>
                  <tr>
                      <th>Entradas</th>
                      <th>Estado </th>
                      <th>Acción</th>
                  </tr>
              </thead>
              <tbody>
                  {% for i in  configs %}
                  {% get_config_state i as state %}
                  <tr>
                      <td> {% for j in i.entradas.all %}
                          <ol> {{j}}</ol>
                          {% endfor%}
                      </td>
                      <td> {{state}}</td>
                      <td>
                          {% if state == 'Sin Iniciar'%}
                          <form>
                  <button class="btn btn-primary" formaction="{% url 'run_pipeline' user.pk i.pk %}" title="Ejecutar"><i class="glyphicon glyphicon-log-in"></i></button>
                  
                   </form>
                          {% elif state == 'Finalizado'%}
                          <form>
                  <button class="btn btn-primary" formaction="{% url 'resultados' i.task_celery_set.all.0.pk %}" title="Ver Resultados">Resultados</button>
                  
                   </form>
                          {% else %}
                          
                          {% endif %}
                          
                      </td>
                      
                  </tr>   
                  
              
                  {% endfor %}
                  
              </tbody>


          </table>
              
              

          </div>
              
          
          
         {% endfor %}
          
              
      </div><!-- tab content -->
      </div><!-- end of container -->

      
      
      
      
      
      

      



  </div>
  
</div>



{% endblock %}